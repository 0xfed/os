package:
  name: syslog-ng
  version: 4.7.1
  epoch: 0
  description: Next generation logging daemon
  copyright:
    - license: GPL-2.0-or-later
  scriptlets:
    post-install: |
      #!/bin/sh

      [ -f /var/log/auth.log ]  || touch /var/log/auth.log
      [ -f /var/log/error.log ] || touch /var/log/error.log
      [ -f /var/log/mail.log ]  || touch /var/log/mail.log
      [ -f /var/log/kern.log ]  || touch /var/log/kern.log
    post-upgrade: |
      #!/bin/sh

      ver_new="$1"
      ver_old="$2"

      if [ "$(apk version -t "$ver_old" "3.18.1-r2")" = "<" ]; then
        cat >&2 <<-EOF
        *
        * The following modules has been moved to separate packages:
        *     add-contextual-data, examples, graphite, map-value-pairs,
        *     python2, redis, stardate, stomp, tags-parser, xml, geoip,
        *     http.
        * If you use one of these, install the relevant package(s), e.g.:
        *     apk add syslog-ng-redis
        *
        * Custom modularized configuration has been replaced with single
        * syslog-ng.conf file that loads fragments from /etc/syslog-ng/conf.d
        * using syslog-ng's include directive.
        *
        EOF
      fi

environment:
  contents:
    packages:
      - autoconf
      - autoconf-archive
      - automake
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl-dev
      - eventlog-dev
      - file
      - flex
      - glib-dev
      - hiredis-dev
      - ivykis-dev
      - json-c-dev
      - libdbi-dev
      - openssl-dev
      - pcre2-dev
      - py3-setuptools
      - python3-dev
      - rabbitmq-c-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/balabit/syslog-ng
      tag: syslog-ng-${{package.version}}
      expected-commit: afd229d3ec2350fe171622755f11a63d3e8d6956

  - uses: patch
    with:
      patches: pyversion.patch

  - runs: |
      autoupdate
      ./autogen.sh

  - runs: |
      CFLAGS="$CFLAGS -flto=auto" \
      CXXFLAGS="$CXXFLAGS -flto=auto" \
      ./configure \
          --prefix=/usr \
          --sysconfdir=/etc/syslog-ng \
          --localstatedir=/run \
          --enable-extra-warnings \
          --enable-ipv6 \
          --enable-manpages \
          --disable-geoip2 \
          --disable-java \
          --disable-java-modules \
          --disable-linux-caps \
          --disable-mongodb \
          --disable-python-modules \
          --disable-riemann \
          --disable-smtp \
          --disable-systemd \
          --enable-amqp \
          --enable-geoip \
          --enable-http \
          --enable-json \
          --enable-native \
          --enable-python \
          --enable-rdrand \
          --enable-redis \
          --enable-sql \
          --enable-stomp \
          --with-ivykis=system \
          --with-jsonc=system \
          --with-librabbitmq-client=system \
          --with-python-packages=system

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      mkdir -p ${{targets.contextdir}}/var/log
      mkdir -p ${{targets.contextdir}}/etc/${{package.name}}
      mkdir -p ${{targets.contextdir}}/etc/init.d
      mkdir -p ${{targets.contextdir}}/var/lib/${{package.name}}
      mkdir -p ${{targets.contextdir}}/etc/logrotate.d/${{package.name}}

      install -m 644 ${{package.name}}.conf ${{targets.contextdir}}/etc/${{package.name}}/${{package.name}}.conf
      install -D -m 755 ${{package.name}}.initd ${{targets.contextdir}}/etc/init.d/${{package.name}}
      install -D -m 644 ${{package.name}}.logrotate ${{targets.contextdir}}/etc/logrotate.d/${{package.name}}

      install -d -m 755 ${{targets.contextdir}}/etc/${{package.name}}/conf.d
      install -d -m 700 ${{targets.contextdir}}/var/lib/${{package.name}}

      rm ${{targets.destdir}}/usr/lib/libsyslog-ng-native-connector.a
      rm ${{targets.destdir}}/usr/lib/${{package.name}}/libtfgetent.so

  - uses: strip

subpackages:
  - name: ${{package.name}}-dev
    pipeline:
      - uses: split/dev
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/share/${{package.name}}/tools
          mkdir -p ${{targets.contextdir}}/usr/share/${{package.name}}/xsd
          mv ${{targets.destdir}}/usr/share/${{package.name}}/tools ${{targets.contextdir}}/usr/share/${{package.name}}/
          mv ${{targets.destdir}}/usr/share/${{package.name}}/xsd ${{targets.contextdir}}/usr/share/${{package.name}}/
    dependencies:
      runtime:
        - ${{package.name}}
    description: ${{package.name}} dev

  - name: ${{package.name}}-doc
    pipeline:
      - uses: split/manpages
    description: ${{package.name}} manpages

  - name: ${{package.name}}-scl
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/share/${{package.name}}/include
          mv ${{targets.destdir}}/usr/share/${{package.name}}/include/scl ${{targets.contextdir}}/usr/share/${{package.name}}/include/
    description: ${{package.name}} scl

  - name: ${{package.name}}-python
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/etc/${{package.name}}
          mkdir -p ${{targets.contextdir}}/usr/lib/${{package.name}}
          mv ${{targets.destdir}}/usr/share/${{package.name}}/libmod-python.so ${{targets.contextdir}}/usr/lib/${{package.name}}/
          mv ${{targets.destdir}}/usr/share/${{package.name}}/python ${{targets.contextdir}}/usr/lib/${{package.name}}/
          mv ${{targets.destdir}}/etc/${{package.name}}/python ${{targets.contextdir}}/etc/${{package.name}}/
    description: ${{package.name}} python

update:
  enabled: true
  github:
    identifier: balabit/syslog-ng
    strip-prefix: syslog-ng-
    use-tag: true
