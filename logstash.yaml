package:
  name: logstash
  version: 8.8.1
  epoch: 0
  description: Logstash - transport and process your logs, events, or other data
  target-architecture:
    - all
  copyright:
    - paths:
        - "*"
      attestation:
      license: Apache-2.0
  dependencies:
    runtime:
      - bash # some helper scripts use bash
      - openjdk-11-jre

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - curl
      - gradle
      - openjdk-11
      - ruby-3.1
      - bash
      - ruby3.1-bundler

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/elastic/logstash
      tag: v${{package.version}}
      expected-commit: f1a41e558cd915ac9d2f91dc3fdd2865cec3343d

  - runs: |
      export OSS=true
      export LOGSTASH_SOURCE=1
      export LANG=en_US.UTF-8
      export GEM_HOME=$PWD/vendor/bundle/jruby/3.1
      export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
      export LS_JAVA_HOME=/usr/lib/jvm/java-11-openjdk

      gem install rake

      ./gradlew installDevelopmentGems
      rake bootstrap
      rake plugin:install-default

      ./gradlew assembleOssTarDistribution

      mkdir -p ${{targets.destdir}}/usr/share/java/logstash
      tar --strip-components 1 -C ${{targets.destdir}}/usr/share/java/logstash -xf build/logstash-oss-*-SNAPSHOT-no-jdk.tar.gz

      mkdir -p ${{targets.destdir}}/usr/bin
      for i in ${{targets.destdir}}/usr/share/java/logstash/bin/*; do
        name=$(basename $i)
        ln -sf /usr/share/java/logstash/bin/$name ${{targets.destdir}}/usr/bin/$name
      done

update:
  enabled: true
  github:
    identifier: elastic/logstash
    strip-prefix: v
    use-tag: true
