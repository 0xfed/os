package:
  name: trino
  version: "430"
  epoch: 1
  description: The distributed SQL query engine for big data, formerly known as PrestoSQL
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash # some helper scripts use bash
      - openjdk-17-default-jvm
      - python3 # required by trino launcher script

environment:
  contents:
    packages:
      - wolfi-base
      - busybox
      - ca-certificates-bundle
      - curl
      - maven
      - build-base
      - openjdk-17
      - git
      - diffutils
      - jvmkill

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/trinodb/trino.git
      tag: ${{package.version}}
      expected-commit: 15024442d61e68bc1bb91fa472fc491dadd9d042

  - uses: patch
    with:
      patches: CVE-2023-36478.patch CVE-2023-5072.patch

  - runs: |
      set -x

      export JAVA_HOME=/usr/lib/jvm/java-17-openjdk

      ./mvnw package -q -DskipTests -T 8  -pl '!:trino-docs,!:trino-server-rpm'

      mkdir -p ${{targets.destdir}}/usr/lib/trino
      cp ./core/trino-server/target/trino-server-${{package.version}}/NOTICE ${{targets.destdir}}/usr/lib/trino/
      cp ./core/trino-server/target/trino-server-${{package.version}}/README.txt ${{targets.destdir}}/usr/lib/trino/
      cp -r ./core/trino-server/target/trino-server-${{package.version}}/bin ${{targets.destdir}}/usr/lib/trino/bin/
      cp -r ./core/trino-server/target/trino-server-${{package.version}}/lib ${{targets.destdir}}/usr/lib/trino/lib/

      # Copy default configurations.
      mkdir -p ${{targets.destdir}}/etc
      cp -r core/docker/default/etc ${{targets.destdir}}/etc/trino

      # Copy docker helper scripts.
      cp core/docker/bin/* ${{targets.destdir}}/usr/lib/trino/bin/
      cp /usr/lib/libjvmkill.so ${{targets.destdir}}/usr/lib/trino/bin/

      # Link launcher script.
      mkdir -p ${{targets.destdir}}/usr/bin
      ln -s /usr/lib/trino/bin/run-trino ${{targets.destdir}}/usr/bin/

      mkdir -p ${{targets.destdir}}/etc/security/
      touch ${{targets.destdir}}/etc/security/limits.conf
      cat << EOF >> ${{targets.destdir}}/etc/security/limits.conf
      trino soft nofile 131072
      trino hard nofile 131072
      trino soft nproc 128000
      trino hard nproc 128000
      EOF

data:
  - name: plugins
    items:
      accumulo: accumulo
      atop: atop
      bigquery: bigquery
      blackhole: blackhole
      cassandra: cassandra
      clickhouse: clickhouse
      delta-lake: delta-lake
      druid: druid
      elasticsearch: elasticsearch
      example-http: example-http
      exchange-filesystem: exchange-filesystem
      exchange-hdfs: exchange-hdfs
      geospatial: geospatial
      google-sheets: google-sheets
      hive: hive
      http-event-listener: http-event-listener
      hudi: hudi
      iceberg: iceberg
      ignite: ignite
      jmx: jmx
      kafka: kafka
      kinesis: kinesis
      kudu: kudu
      local-file: local-file
      mariadb: mariadb
      memory: memory
      ml: ml
      mongodb: mongodb
      mysql: mysql
      mysql-event-listener: mysql-event-listener
      oracle: oracle
      password-authenticators: password-authenticators
      phoenix5: phoenix5
      pinot: pinot
      postgresql: postgresql
      prometheus: prometheus
      raptor-legacy: raptor-legacy
      redis: redis
      redshift: redshift
      resource-group-managers: resource-group-managers
      session-property-managers: session-property-managers
      singlestore: singlestore
      sqlserver: sqlserver
      teradata-functions: teradata-functions
      thrift: thrift
      tpcds: tpcds
      tpch: tpch

subpackages:
  - range: plugins
    name: trino-plugin-${{range.key}}
    description: Trino Plugin ${{range.key}}
    dependencies:
      runtime:
        - trino
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib/trino/plugin/${{range.value}}
          cp -r ./core/trino-server/target/trino-server-${{package.version}}/plugin/${{range.value}} ${{targets.subpkgdir}}/usr/lib/trino/plugin/

update:
  enabled: true
  github:
    identifier: trinodb/trino
    use-tag: true
