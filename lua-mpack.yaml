package:
  name: lua-mpack
  version: 1.0.11
  epoch: 0
  description: "Libmpack bindings for Lua"
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - libmpack-dev
      - luajit-dev
      - wolfi-baselayout

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/libmpack/libmpack-lua
      tag: ${{package.version}}
      expected-commit: fbd13c9760f0b7841ae30ae635accbd89b1b49cd

  - name: "Configure"
    runs: |
      make \
        FETCH=false \
        USE_SYSTEM_LUA=yes \
        USE_SYSTEM_MPACK=yes \
        LUA_INCLUDE="$(pkg-config --cflags luajit)" \
        LUA_LIB="$(pkg-config --libs luajit)"

      make \
        USE_SYSTEM_LUA=yes \
        USE_SYSTEM_MPACK=yes \
        LUA_CMOD_INSTALLDIR="$(pkg-config --variable=INSTALL_CMOD luajit)" \
        DESTDIR="${{targets.destdir}}" \
        install

  - runs: |
      rockdir=${{targets.destdir}}/usr/lib/luarocks/rocks-common/mpack/${{package.version}}-0
      mkdir -p $rockdir
      echo "rock_manifest = {}" > "$rockdir"/rock_manifest

update:
  enabled: true
  github:
    identifier: libmpack/libmpack-lua
