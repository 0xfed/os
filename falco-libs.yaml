package:
  name: falco-libs
  version: 0.13.2
  epoch: 0
  description: Foundational components necessary to build Falco
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - gcc
      - cmake
      - make
      - git
      - bash
      - perl
      - linux-headers
      - autoconf
      - automake
      - m4
      - libtool
      - elfutils-dev
      - libelf
      - libelf-static
      - patch
      - binutils
      - c-ares-dev
      - curl-dev
      - grpc-dev
      - jq-dev
      - yaml-cpp-dev
      - openssl-dev
      - protobuf-dev
      - zlib-dev
      - clang-16-dev
      - bpftool
      - gtest-dev
      - libtbb-dev
      - json-c-dev
      - luajit
      - re2-dev
      - libbpf-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/falcosecurity/libs
      tag: ${{package.version}}
      expected-commit: 3977c2d638455cac5d978135bd883fa5c59ac8ed

data:
  - name: libs
    items:
      libscap: System capture library to manage the data capture process
      libscap-modern-ebpf: System capture library to manage the data capture process with modern eBPF driver

subpackages:
  - range: libs
    name: falco-${{range.key}}
    description: ${{range.value}}
    pipeline:
      - runs: |
          export MODERN_BPF=Off
          [ "${{range.key}}" == "libscap-modern-ebpf" ] && export MODERN_BPF=On

          mkdir -p build
          cd build
          cmake \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_INSTALL_LIBDIR=/usr/lib \
            -DFALCO_ETC_DIR=/etc/falco \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_BUNDLED_DEPS=Off \
            -DUSE_BUNDLED_JSONCPP=On \
            -DUSE_BUNDLED_VALIJSON=On \
            -DMINIMAL_BUILD=On \
            -DBUILD_LIBSCAP_MODERN_BPF=${MODERN_BPF} \
          ..

      - runs: |
          cd build
          make scap

          mkdir -p "${{targets.subpkgdir}}"/usr/lib/${{range.key}}
          cp -R ../userspace/libscap/. "${{targets.subpkgdir}}"/usr/lib/${{range.key}}

      - uses: strip

update:
  enabled: true
  github:
    identifier: falcosecurity/libs
          
