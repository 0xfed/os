package:
  name: confluent-kafka
  version: 7.7.0.301
  epoch: 0
  description: Community edition of Confluent Kafka.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash # Requied by this images - uses shell to launch image wth zookeeper.
      - zookeeper

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - curl
      - gradle
      - openjdk-11
      - sbt

# Convert back to original format which can be used in git fetch.
var-transforms:
  - from: ${{package.version}}
    match: "_"
    replace: "-"
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/confluentinc/kafka
      tag: v${{vars.mangled-package-version}}-ccs
      expected-commit: ab63fe9ca0e7bfa1011e2101bfa891684f392c0d

  - runs: |
      export JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF8

      gradle clean releaseTarGz

      nohup /usr/lib/kafka/bin/zookeeper-server-start.sh /usr/lib/kafka/config/zookeeper.properties > ${{targets.destdir}}/usr/lib/kafka/logs/zookeeper.out 2> zookeeper.err < /dev/null &
      tar -xzvf core/build/distributions/kafka_*-${{vars.mangled-package-version}}-ccs.tgz

      mkdir -p ${{targets.destdir}}/usr/lib/kafka/logs

      mv kafka_*-${{vars.mangled-package-version}}-ccs/bin ${{targets.destdir}}/usr/lib/kafka
      mv kafka_*-${{vars.mangled-package-version}}-ccs/libs ${{targets.destdir}}/usr/lib/kafka
      mv kafka_*-${{vars.mangled-package-version}}-ccs/config ${{targets.destdir}}/usr/lib/kafka

      # Clean up windows
      rm -rf ${{targets.destdir}}/usr/lib/kafka/bin/*.bat

update:
  enabled: true
  # src version contains '-', which melange doesn't like.
  version-transform:
    - match: "-"
      replace: "."
  github:
    identifier: confluentinc/kafka
    use-tag: true
    strip-suffix: -ccs

test:
  environment:
    contents:
      packages:
        - zookeeper
  pipeline:
    - runs: |
        # Define Kafka base directory
        KAFKA_DIR="${targets_destdir}/usr/lib/kafka"

        echo "Starting Zookeeper..."
        nohup "${KAFKA_DIR}/bin/zookeeper-server-start.sh" \
          "${KAFKA_DIR}/config/zookeeper.properties" > "${KAFKA_DIR}/logs/zookeeper.out" 2> \
          "${KAFKA_DIR}/logs/zookeeper.err" < /dev/null &
        ZOO_PID=$!
        sleep 5
        grep "Created server with tickTime" "${KAFKA_DIR}/logs/zookeeper.out" > /dev/null || { echo "Zookeeper log entry not found"; exit 1; }

        echo "Starting Kafka..."
        nohup "${KAFKA_DIR}/bin/kafka-server-start.sh" "${KAFKA_DIR}/config/server.properties" > "${KAFKA_DIR}/logs/kafka.out" 2> "${KAFKA_DIR}/logs/kafka.err" < /dev/null &
        KAFKA_PID=$!
        sleep 5
        grep "Controller 0 connected" "${KAFKA_DIR}/logs/controller.log" > /dev/null || { echo "Kafka log entry not found"; exit 1; }

        # Cleanup
        kill $KAFKA_PID
        kill $ZOO_PID
