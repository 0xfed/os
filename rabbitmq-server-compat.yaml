package:
  name: rabbitmq-server-compat
  version: 3.13.2
  epoch: 0
  description: compat package for rabbitmq
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash
      - busybox
      - coreutils
      - posix-libc-utils
      - rabbitmq-server

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl
      - openssl
      - procps
      - rabbitmq-server

pipeline:
  - uses: bitnami/compat
    with:
      image: rabbitmq
      version-path: 3.13/debian-12

  - runs: |
      mkdir -p ${{targets.destdir}}/opt/bitnami/rabbitmq
      # this is not ideal, but symlinks don't work and there are hundreds of files to track
      cp -r /usr/lib/rabbitmq/lib/rabbitmq_server-3.13.2/* ${{targets.destdir}}/opt/bitnami/rabbitmq

      # this is where the helm chart stores data and mounts volumes
      mkdir -p ${{targets.destdir}}/opt/bitnami/rabbitmq/.rabbitmq

      mkdir -p ${{targets.destdir}}/opt/bitnami/rabbitmq/etc/rabbitmq
      mkdir -p ${{targets.destdir}}/opt/bitnami/rabbitmq/etc/rabbitmq.default
      mkdir -p ${{targets.destdir}}/opt/bitnami/rabbitmq/var/log/rabbitmq
      mkdir -p ${{targets.destdir}}/opt/bitnami/rabbitmq/var/lib/rabbitmq
      mkdir -p ${{targets.destdir}}/opt/bitnami/scripts/rabbitmq
      mkdir -p ${{targets.destdir}}/bitnami/rabbitmq

      mkdir -p ${{targets.destdir}}/opt/bitnami/erlang/lib
      ln -sf /usr/lib/erlang ${{targets.destdir}}/opt/bitnami/erlang/lib/erlang

      # Use package path while unpacking
      find . -iname "*.sh" -exec sed 's#/opt/bitnami#${{targets.destdir}}/opt/bitnami#g' -i {} \;
        ${{targets.destdir}}/opt/bitnami/scripts/rabbitmq/postunpack.sh || true
      # Restore path
      find ${{targets.destdir}}/opt/bitnami -type f -exec sed 's#${{targets.destdir}}##g' -i {} \;

      mkdir -p ${{targets.destdir}}/var/log
      ln -sf /opt/bitnami/rabbitmq/var/log/rabbitmq ${{targets.destdir}}/var/log/rabbitmq
      mkdir -p ${{targets.destdir}}/var/lib
      ln -sf /opt/bitnami/rabbitmq/.rabbitmq ${{targets.destdir}}/var/lib/rabbitmq

update:
  enabled: true
  github:
    identifier: rabbitmq/rabbitmq-server
    strip-prefix: v
