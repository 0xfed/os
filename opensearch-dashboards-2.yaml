package:
  name: opensearch-dashboards-2
  version: 2.11.1
  epoch: 0
  description: Open source visualization dashboards for OpenSearch
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - apk-tools
      - build-base
      - busybox
      - ca-certificates-bundle
      - gcc-12
      - gcc-12-default
      - git
      - node-gyp
      - nodejs-18
      - py3-setuptools
      - python3
      - xorg-server
      - yarn
  environment:
    CC: gcc
    CXX: g++

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/opensearch-project/OpenSearch-Dashboards.git
      tag: ${{package.version}}
      expected-commit: 989d8f41f37cca3275bf3fedc5c2057a717d1d64

  - runs: |
      # Workaround for "OpenSearch Dashboards should not be run as root.  Use --allow-root to continue."
      # This change will add the --allow-root when running the build_ts_refs and register_git_hook scripts
      sed -i 's/\("osd:bootstrap": "scripts\/use_node scripts\/build_ts_refs\)\( && scripts\/use_node scripts\/register_git_hook\)/\1 --allow-root\2 --allow-root/' package.json

  - runs: |
      # Our commond LDFLAGS cause some issues when building for aarch64. We
      # unset our global flags to allow the build to succeed.
      unset LDFLAGS
      yarn osd bootstrap --allow-root
      yarn build-platform --linux-arm --skip-os-packages --release --allow-root

      install -dm755 build/opensearch-dashboards-${{package.version}}-linux-arm64 "${{targets.destdir}}/usr/share/opensearch-dashboards"

  - uses: strip

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility package to place Docker startup scripts.
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/usr/local/bin"
          install -m755 src/dev/build/tasks/os_packages/docker_generator/resources/bin/opensearch-dashboards-docker "${{targets.contextdir}}/usr/local/bin/opensearch-dashboards-docker"

update:
  enabled: true
  github:
    identifier: opensearch-project/OpenSearch-Dashboards
    tag-filter: 2.
