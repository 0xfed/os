package:
  name: opensearch-dashboards-2
  version: 2.11.1
  epoch: 0
  description: Open source visualization dashboards for OpenSearch
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - apk-tools
      - build-base
      - busybox
      - ca-certificates-bundle
      - gcc-12
      - gcc-12-default
      - node-gyp
      - nodejs-18
      - py3-setuptools
      - python3
      - xorg-server
      - yarn
  environment:
    CC: gcc
    CXX: g++

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/opensearch-project/OpenSearch-Dashboards.git
      tag: ${{package.version}}
      expected-commit: 989d8f41f37cca3275bf3fedc5c2057a717d1d64

  - runs: |
      # Workaround for "OpenSearch Dashboards should not be run as root.  Use --allow-root to continue.""
      # This change will add the --allow-root when running the build_ts_refs and register_git_hook scripts
      sed -i 's/\("osd:bootstrap": "scripts\/use_node scripts\/build_ts_refs\)\( && scripts\/use_node scripts\/register_git_hook\)/\1 --allow-root\2 --allow-root/' package.json

  - runs: |
      # Our commond LDFLAGS cause some issues when building for aarch64. We
      # unset our global flags to allow the build to succeed.
      unset LDFLAGS
      yarn osd bootstrap
      ./scripts/use_node scripts/build_opensearch_dashboards_platform_plugins --no-examples --workers 5

      install -Dm755 assets "${{targets.destdir}}"/usr/share/opensearch-dashboards/assets
      install -Dm755 config "${{targets.destdir}}"/usr/share/opensearch-dashboards/config
      install -Dm755 data "${{targets.destdir}}"/usr/share/opensearch-dashboards/data
      install -Dm755 node_modules "${{targets.destdir}}"/usr/share/opensearch-dashboards/node_modules
      install -Dm755 plugins "${{targets.destdir}}"/usr/share/opensearch-dashboards/plugins

  - uses: strip

update:
  enabled: true
  github:
    identifier: opensearch-project/OpenSearch-Dashboards
    tag-filter: 2.
