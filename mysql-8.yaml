package:
  name: mysql-8
  version: 8.0.32
  epoch: 0
  description: MySQL Server, the world's most popular open source database
  copyright:
    - license: GPL-2.0-only
  dependencies:
    runtime:

environment:
  contents:
    packages:
      - build-base
      - ca-certificates-bundle
      - cmake
      - busybox
      - boost
      - ncurses-dev
      - bison
      - m4
      - libtirpc-dev
      - libuv-dev
      - openssl-dev
      - zstd
      - glibc-dev
      - rpcsvc-proto

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/mysql/mysql-server
      tag: mysql-${{package.version}}
      expected-commit: 1bfe02bdad6604d54913c62614bde57a055c8332
      depth: 1

  - working-directory: bld
    pipeline:
      - name: Build
        runs: |
          cmake .. \
            -DCMAKE_INSTALL_PREFIX="${{targets.destdir}}"/usr/bin/mysql-${{package.version}} \
            -DDOWNLOAD_BOOST=1 \
            -DWITH_BOOST=/usr/bin/lib/boost \
            -DWITH_SSL=system \
            -DBUILD_CONFIG=mysql_release
      - name: Install
        runs: |
          make
          make install DESTDIR="${{targets.destdir}}"/usr/bin/mysql

  - uses: strip

subpackages:
  - name: "mysql-dev"
    description: headers for mysql
    pipeline:
      - uses: split/dev

  - name: mysql-doc
    pipeline:
      - uses: split/manpages

  - name: mysql-test
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/mysql-8/mysql-test "${{targets.subpkgdir}}"/usr/

update:
  enabled: true
  github:
    identifier: mysql/mysql-server
    strip-prefix: mysql-
    use-tag: true
    tag-filter: mysql-8
