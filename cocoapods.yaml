package:
  name: cocoapods
  version: 1.13.0
  epoch: 0
  description: CocoaPods manages dependencies for your Xcode projects.
  copyright:
    - paths:
        - "*"
      attestation:
      license: MIT
  dependencies:
    runtime:
      - ruby-3.2
      - ruby3.2-bundler
      - git

environment:
  contents:
    packages:
      - ca-certificates-bundle
      - ruby-3.2
      - ruby-3.2-dev
      - ruby3.2-bundler
      - build-base
      - busybox
      - git

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/CocoaPods/CocoaPods
      tag: ${{package.version}}
      expected-commit: cada725a86af59193168cd36745997333e75648c

  - runs: |
      GEM_DIR=${{targets.destdir}}$(ruby -e 'puts Gem.default_dir')
      bundle config set --local path ${GEM_DIR}
      bundle config set --local without 'development test'
      echo "gemhome: ${GEM_DIR}" >> ~/.gemrc
      echo "gem: --no--document" >> ~/.gemrc

      bundle install
      gem build
      gem install --bindir ${{targets.destdir}}/usr/bin ${{package.name}}-${{package.version}}.gem

      # https://stackoverflow.com/questions/77236339/after-updating-cocoapods-to-1-13-0-it-throws-error
      # There's a transitive runtime dep on activesupport resolving to 7.1.0;
      # cocoapods --> cocoapods-core --> activesupport >= 5.0, <8
      # But version 7.1.0 has a bug, so we uninstall it and reinstall it
      gem uninstall --force activesupport # -v 7.1.0
      gem install activesupport -v 7.0.8

      rm -rf ${GEM_DIR}/cache

update:
  enabled: true
  github:
    identifier: CocoaPods/CocoaPods
    use-tag: true
