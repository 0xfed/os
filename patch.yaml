package:
  name: patch
  version: 2.7.6
  epoch: 2
  description: "GNU patch"
  target-architecture:
    - all
  copyright:
    - paths:
      - "*"
      attestation: TODO
      license: GPL-3.0-or-later
  dependencies:
    runtime:

secfixes:
  2.7.6-r7:
    - CVE-2019-20633
  2.7.6-r6:
    - CVE-2018-1000156
    - CVE-2019-13638
    - CVE-2018-20969
  2.7.6-r5:
    - CVE-2019-13636
  2.7.6-r2:
    - CVE-2018-6951
  2.7.6-r4:
    - CVE-2018-6952

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/bootstrap/stage3
    keyring:
      - https://packages.wolfi.dev/bootstrap/stage3/wolfi-signing.rsa.pub
    packages:
      - wolfi-baselayout
      - busybox
      - ca-certificates-bundle
      - build-base

pipeline:
  - uses: fetch
    with:
      uri: https://ftp.gnu.org/gnu/patch/patch-${{package.version}}.tar.gz
      expected-sha256: 8cf86e00ad3aaa6d26aca30640e86b0e3e1f395ed99f189b06d4c9f74bc58a4e

  - uses: fetch
    with:
      uri: https://git.alpinelinux.org/aports/plain/main/patch/CVE-2018-6951.patch
      expected-sha256: 8a7b920cc0c770a992dfa287a1cb6dc4dfb5e3a16afe7109ef0d470f237a0909
      extract: false

  - uses: fetch
    with:
      uri: https://git.alpinelinux.org/aports/plain/main/patch/CVE-2018-6952.patch
      expected-sha256: 4b9e81985ca057fa39daed34a4710eb113f08b3d1ce77a7121ddd8e3fae8007a
      extract: false

  - uses: fetch
    with:
      uri: https://git.alpinelinux.org/aports/plain/main/patch/0001-Allow-input-files-to-be-missing-for-ed-style-patches.patch
      expected-sha256: c2e9d1d960c8cf04dd732ddfa73e267e9a956fbc6d7bf99cf2d3a7c0f9a6d05f
      extract: false

  - uses: fetch
    with:
      uri: https://git.alpinelinux.org/aports/plain/main/patch/0002-Fix-arbitrary-command-execution-in-ed-style-patches-.patch
      expected-sha256: 7a7836be33fe496c0b59a35b02ac12b9ad7e61ee0ced5017bbf6cf891e726f74
      extract: false

  - uses: fetch
    with:
      uri: https://git.alpinelinux.org/aports/plain/main/patch/CVE-2019-13636.patch
      expected-sha256: ad82a53414bab8c69f8e0d688e4b492730be1a658275b55507ebb96d882d8683
      extract: false

  - uses: fetch
    with:
      uri: https://git.alpinelinux.org/aports/plain/main/patch/CVE-2019-13638.patch
      expected-sha256: 084ee9793b7112e6ae9ecfe5e6c0f0b1f431aecaf46144730b6892142abdbea2
      extract: false

  - uses: fetch
    with:
      uri: https://git.alpinelinux.org/aports/plain/main/patch/CVE-2019-20633.patch
      expected-sha256: 97ac2b1092917f3082194b0abc1cf7561afe00035e1f04c0e57331427e82d43a
      extract: false

  - uses: patch
    with:
      patches: CVE-2018-6951.patch

  - uses: patch
    with:
      patches: CVE-2018-6952.patch

  - uses: patch
    with:
      patches: 0001-Allow-input-files-to-be-missing-for-ed-style-patches.patch

  - uses: patch
    with:
      patches: 0002-Fix-arbitrary-command-execution-in-ed-style-patches-.patch

  - uses: patch
    with:
      patches: CVE-2019-13636.patch

  - uses: patch
    with:
      patches: CVE-2019-13638.patch

  - uses: patch
    with:
      patches: CVE-2019-20633.patch

  - name: Configure
    runs: |
      ./configure \
         --host=$(uname -m)-pc-linux-gnu \
         --target=$(uname -m)-pc-linux-gnu \
         --prefix=/usr \
         --datadir=/usr/share
  - uses: autoconf/make
  - uses: autoconf/make-install
  - uses: strip
