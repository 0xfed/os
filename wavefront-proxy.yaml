package:
  name: wavefront-proxy
  version: 12.4
  epoch: 0
  description: Wavefront Proxy Project
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - openjdk-11-jre

environment:
  contents:
    packages:
      - wolfi-baselayout
      - busybox
      - build-base
      - openjdk-11
      - maven
      - ca-certificates-bundle

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/wavefronthq/wavefront-proxy
      tag: proxy-${{package.version}}
      expected-commit: 7170d26b802e5f4b2201c3a38c2d11e6e3ad719a

  - runs: |
      export LANG=en_US.UTF-8
      export JAVA_HOME=/usr/lib/jvm/openjdk
      mvn -f proxy --batch-mode clean package -DskipTests -DskipFormatCode
      mkdir -p ${{targets.destdir}}/opt/wavefront/wavefront-proxy
      mv /home/build/proxy/target/proxy-${{package.version}}-spring-boot.jar ${{targets.destdir}}/opt/wavefront/wavefront-proxy/wavefront-proxy.jar

subpackages:
  - name: ${{package.name}}-config
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/etc/wavefront/wavefront-proxy
          cp docker/log4j2.xml \
          "${{targets.subpkgdir}}"/etc/wavefront/wavefront-proxy/log4j2.xml
    dependencies:
      runtime:
        - wavefront-proxy

  - name: ${{package.name}}-licenses
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/licenses
          cp docker/LICENSE \
          "${{targets.subpkgdir}}"/licenses/LICENSE
    dependencies:
      runtime:
        - wavefront-proxy

  - name: ${{package.name}}-oci-entrypoint
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/local/bin/
          cp docker/run.sh ${{targets.subpkgdir}}/usr/local/bin/
          chmod +x ${{targets.subpkgdir}}/usr/local/bin/run.sh
    dependencies:
      runtime:
        - wavefront-proxy-config
        - wavefront-proxy-licenses

update:
  enabled: true
  github:
    identifier: wavefronthq/wavefront-proxy
    strip-prefix: proxy-
    use-tag: true
    tag-filter: proxy-
