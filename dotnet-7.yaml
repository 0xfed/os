package:
  name: dotnet-7
  version: 7.0.104
  epoch: 0
  description: ".NET SDK"
  target-architecture:
    - all
  copyright:
    - paths:
      - "*"
      attestation: TODO
      license: MIT
  dependencies:
    runtime:
    - icu-dev

environment:
  contents:
    packages:
      - wolfi-base
      - busybox
      - ca-certificates-bundle
      - build-base
      - ncurses-dev
      - clang-15
      - llvm15
      - krb5-dev
      - zlib-dev
      - icu-dev
      - openssl-dev
      - lttng-ust-dev
      - glibc-locale-en
      - python3
      - cmake
      - samurai
      - curl
      - bash
      - libunwind-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/dotnet/installer
      branch: v7.0.104
      destination: /home/build/installer
  - working-directory: /home/build/installer
    runs: |
      ./build.sh /p:ArcadeBuildTarball=true /p:TarballDir=/home/build/src
  - working-directory: /home/build/src
    runs: |
      sed -i -E 's|( /p:BuildDebPackage=false)|\1 /p:EnablePackageValidation=false|' src/runtime/eng/SourceBuild.props
      sed -i -E 's|( /p:BuildDebPackage=false)|\1 --cmakeargs -DCLR_CMAKE_USE_SYSTEM_LIBUNWIND=TRUE|' src/runtime/eng/SourceBuild.props
      ./prep.sh --bootstrap
  - working-directory: /home/build/src
    runs: |
      ./build.sh --online --clean-while-building \
        -- \
        /v:n \
        /p:ContinueOnPrebuiltBaselineError=true \
        /p:MinimalConsoleLogOutput=false \
        /p:PrebuiltPackagesPath=/home/build/src/packages \
        /p:SkipPortableRuntimeBuild=true
  - working-directory: /home/build/src
    assertions:
      required-steps: 1
    pipeline:
      - if: ${{build.arch}} == 'aarch64'
        runs: |
          cd /home/build/src
          mkdir -p ${{targets.destdir}}/usr/share/dotnet
          mkdir -p ${{targets.destdir}}/usr/bin
          tar zxf artifacts/arm64/Release/dotnet-sdk-*.tar.gz -C ${{targets.destdir}}/usr/share/dotnet
          ln -s /usr/share/dotnet/dotnet ${{targets.destdir}}/usr/bin/dotnet
      - if: ${{build.arch}} == 'x86_64'
        runs: |
          cd /home/build/src
          mkdir -p ${{targets.destdir}}/usr/share/dotnet
          mkdir -p ${{targets.destdir}}/usr/bin
          tar zxf artifacts/x64/Release/dotnet-sdk-*.tar.gz -C ${{targets.destdir}}/usr/share/dotnet
          ln -s /usr/share/dotnet/dotnet ${{targets.destdir}}/usr/bin/dotnet
  - uses: strip
