package:
  name: brew
  version: 4.1.23
  epoch: 0
  description: "The homebrew package manager"
  copyright:
    - license: BSD-2
  dependencies:
    runtime:
      - bash
      - build-base
      - busybox
      - coreutils
      - curl
      - gcc
      - git
      - grep
      - posix-libc-utils
      - procps
      - ruby-3.1
  # Drop commands/depends/provides as the SCA doesn't work on brew since itself is a package manager
  options:
    no-commands: true
    no-depends: true
    no-provides: true
  scriptlets:
    post-install: |
      #!/bin/sh
      echo
      echo "To use brew for the first time, you will need /home/linuxbrew/.linuxbrew/bin in your PATH:"
      echo ". /etc/profile.d/brew.sh"
      echo

environment:
  contents:
    packages:
      - git
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Homebrew/brew
      tag: ${{package.version}}
      destination: ./brew
  - runs: |
     set -x
     mkdir -p ${{targets.destdir}}/home/linuxbrew/.linuxbrew/
     rm -rf ./brew/.git/
     mv ./brew/ ${{targets.destdir}}/home/linuxbrew/.linuxbrew/
     cd ${{targets.destdir}}/home/linuxbrew/.linuxbrew/brew/bin/
     mkdir -p ${{targets.destdir}}/etc/profile.d/
     echo "export PATH=\$PATH:/home/linuxbrew/.linuxbrew/brew/bin" > ${{targets.destdir}}/etc/profile.d/brew.sh
     echo "export HOMEBREW_NO_AUTO_UPDATE=1" >> ${{targets.destdir}}/etc/profile.d/brew.sh

update:
  enabled: true
  github:
    identifier: Homebrew/brew

# TODO: Test failing because melange is running test as root; need to drop privileges
#test:
# pipeline:
#   - runs: |
#       . /etc/profile.d/brew.sh
#       brew install hello
#       hello
